{% raw %}{%{% endraw %} set python_versions_str = config.python_versions | join(", ") {% raw %}%}{%{% endraw %}
stages:
  - build
  - test
  - report
  {% if config.template_type.value == 'enterprise' %}
  - security
  - deploy
  {% endif %}

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "{{ config.python_versions | first }}"
  {% if config.secrets %}
  {% for secret in config.secrets %}
  {{ secret }}: "${{ secret }}"
  {% endfor %}
  {% endif %}

# Global cache configuration
default:
  cache:
    key:
      files:
        - requirements.txt
    paths:
      - .cache/pip/
  interruptible: true

# Workflow rules
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    {% if config.template_type.value == 'nightly' %}
    - if: $CI_PIPELINE_SOURCE == "schedule"
    {% endif %}

{% if config.template_type.value == 'matrix' %}
# Matrix testing job
.matrix_testing:
  stage: test
  image: python:$PYTHON_VERSION
  timeout: {{ config.timeout_minutes | default(30) }} minutes
  parallel:
    matrix:
      - PYTHON_VERSION: [{{ python_versions_str }}]
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -e .
  script:
    - pytest --cov=socialseed_e2e --cov-report=xml --cov-report=html -v
  artifacts:
    when: always
    paths:
      - coverage.xml
      - htmlcov/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: report.xml
    expire_in: 30 days
  coverage: '/TOTAL.*\s+(\d+%)$/'

test:matrix:
  extends: .matrix_testing
  {% if config.needs_cache %}
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .cache/pip/
  {% endif %}

{% elif config.template_type.value == 'parallel' %}
# Parallel test execution
test:parallel:
  stage: test
  image: python:{{ config.python_versions | first }}
  timeout: {{ config.timeout_minutes | default(30) }} minutes
  parallel: {{ config.parallel_workers | default(4) }}
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -e .
  script:
    # Split tests across parallel jobs
    - |
      TEST_FILES=$(find tests -name "test_*.py" | sort)
      TOTAL_TESTS=$(echo "$TEST_FILES" | wc -l)
      CHUNK_SIZE=$(( (TOTAL_TESTS + CI_NODE_TOTAL - 1) / CI_NODE_TOTAL ))
      START=$(( (CI_NODE_INDEX - 1) * CHUNK_SIZE + 1 ))
      END=$(( START + CHUNK_SIZE - 1 ))
      SELECTED_TESTS=$(echo "$TEST_FILES" | sed -n "${START},${END}p")
      echo "Running tests $START to $END (node $CI_NODE_INDEX of $CI_NODE_TOTAL)"
      echo "$SELECTED_TESTS" | xargs pytest -v --tb=short
  artifacts:
    when: always
    paths:
      - test-results/
    reports:
      junit: test-results/junit.xml

{% elif config.template_type.value == 'enterprise' %}
# Enterprise-grade pipeline with comprehensive stages
lint:
  stage: build
  image: python:{{ config.python_versions | first }}
  script:
    - pip install black flake8 mypy
    - black --check src/
    - flake8 src/ --max-line-length=100
    - mypy src/socialseed_e2e --ignore-missing-imports
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

security_scan:
  stage: security
  image: python:{{ config.python_versions | first }}
  needs: [lint]
  script:
    - pip install bandit safety
    - bandit -r src/ -f json -o bandit-report.json || true
    - safety check --json --output safety-report.json || true
  artifacts:
    paths:
      - bandit-report.json
      - safety-report.json
    expire_in: 30 days
  allow_failure: true

test:unit:
  stage: test
  image: python:{{ config.python_versions | first }}
  needs: [lint]
  script:
    - pip install -r requirements.txt
    - pip install -e .
    - pytest tests/unit -v --cov=socialseed_e2e --cov-report=xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml

test:integration:
  stage: test
  image: python:{{ config.python_versions | first }}
  needs: [test:unit]
  script:
    - pip install -r requirements.txt
    - pip install -e .
    - pytest tests/integration -v --cov=socialseed_e2e --cov-append
  artifacts:
    paths:
      - coverage.xml

test:e2e:
  stage: test
  image: python:{{ config.python_versions | first }}
  needs: [test:integration]
  timeout: {{ config.timeout_minutes | default(45) }} minutes
  script:
    - pip install -r requirements.txt
    - pip install -e .
    - e2e run -v
  artifacts:
    when: always
    paths:
      - test-results/
      - reports/
    expire_in: 30 days

coverage_report:
  stage: report
  image: python:{{ config.python_versions | first }}
  needs: [test:unit, test:integration]
  script:
    - pip install coverage
    - coverage combine
    - coverage report
    - coverage html
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    paths:
      - htmlcov/
    expire_in: 30 days

deploy:staging:
  stage: deploy
  image: alpine:latest
  needs: [test:e2e, security_scan]
  environment:
    name: staging
    url: https://staging.example.com
  script:
    - echo "Deploying to staging..."
  only:
    - develop

deploy:production:
  stage: deploy
  image: alpine:latest
  needs: [test:e2e, security_scan]
  environment:
    name: production
    url: https://production.example.com
  script:
    - echo "Deploying to production..."
  only:
    - main
  when: manual

{% else %}
# Basic GitLab CI configuration
test:
  stage: test
  image: python:{{ config.python_versions | first }}
  timeout: {{ config.timeout_minutes | default(30) }} minutes
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install -e .
  script:
    - e2e run -v
  artifacts:
    when: always
    paths:
      - test-results/
{% endif %}
