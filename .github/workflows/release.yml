name: Release to PyPI

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Run full test suite before release
  test:
    name: Run Tests Before Release
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Clean pip cache
        run: |
          pip cache purge || true
          rm -rf ~/.cache/pip

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: '**/pyproject.toml'

      - name: Verify fixes are applied
        run: |
          python verify_fixes.py

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" --no-cache-dir

      - name: Install Playwright
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Run tests with coverage
        run: |
          # Clean pytest cache first
          rm -rf .pytest_cache
          pytest --cov=socialseed_e2e --cov-report=xml --cov-fail-under=45 -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-python${{ matrix.python-version }}
          path: coverage.xml
          retention-days: 5

  # Build and publish to PyPI
  build-and-publish:
    name: Build and Publish to PyPI
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/socialseed-e2e
    permissions:
      id-token: write  # For OIDC publishing
      contents: write  # For creating GitHub releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine check-wheel-contents

      - name: Verify tag matches version
        run: |
          # Extract version from tag (remove 'v' prefix)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Tag version: $TAG_VERSION"

          # Extract version from package (read from file without importing)
          PACKAGE_VERSION=$(grep -oP '__version__ = "\K[^"]+' src/socialseed_e2e/__version__.py)
          echo "Package version: $PACKAGE_VERSION"

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "::error::Version mismatch! Tag: $TAG_VERSION, Package: $PACKAGE_VERSION"
            exit 1
          fi

          echo "‚úÖ Version match verified: $TAG_VERSION"

      - name: Build package
        run: |
          echo "Building package..."
          python -m build

          echo "Built files:"
          ls -lh dist/

      - name: Check distribution
        run: |
          echo "Checking wheel contents..."
          check-wheel-contents dist/*.whl

          echo "Checking with twine..."
          twine check dist/*

      - name: Test installation from built package
        run: |
          echo "Testing installation..."
          pip install dist/*.whl
          python -c "import socialseed_e2e; print(f'Version: {socialseed_e2e.__version__}')"
          e2e --version

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          print-hash: true
          attestations: true

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: build-and-publish
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Generate release notes
        id: release_notes
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## Changes since $PREVIOUS_TAG" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> release_notes.md
          else
            echo "## Initial Release" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s (%h)" >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "pip install socialseed-e2e==${GITHUB_REF#refs/tags/v}" >> release_notes.md
          echo "\`\`\`" >> release_notes.md

          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post to Slack
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "üöÄ socialseed-e2e ${{ github.ref_name }} released to PyPI!\nüì¶ https://pypi.org/project/socialseed-e2e/${{ github.ref_name }}\nüìù https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  # Verify PyPI release
  verify-pypi:
    name: Verify PyPI Release
    needs: build-and-publish
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the release if verification fails

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Wait for PyPI
        run: sleep 90

      - name: Verify package on PyPI
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Attempting to install socialseed-e2e==$VERSION from PyPI..."
          
          # Retry logic with exponential backoff
          for i in 1 2 3 4 5; do
            echo "Attempt $i..."
            if pip install socialseed-e2e==$VERSION; then
              python -c "import socialseed_e2e; print(f'‚úÖ socialseed-e2e {socialseed_e2e.__version__} successfully installed from PyPI')"
              exit 0
            fi
            echo "Attempt $i failed. Waiting before retry..."
            sleep 30
          done
          
          echo "‚ö†Ô∏è Could not verify package on PyPI, but it may have been published successfully."
          echo "Please check https://pypi.org/project/socialseed-e2e/$VERSION/ manually."
          exit 0  # Don't fail the workflow
